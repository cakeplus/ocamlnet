TOP_DIR=../..

PKGNAME = netcgi_apache
BUILD_EXTRA = netcgi_apache.so

INCLUDES += $(INC_NETSTRING) $(INC_NETSYS) $(INC_NETCGI2)

CMA_SO = unix.cma str.cma pcre.cma netsys.cma netstring.cma netcgi.cma

OBJECTS = netcgi_modtpl.cmo

ALL_EXTRA = netcgi_apache.so
INSTALL_EXTRA = netcgi_apache.so 500netcgi_apache.info

# netcgi_apache.so: apache.o handler.o wrappers.o netcgi_apache.cmo
# 	$(OCAMLC) -o $@ -linkall -custom \
# 	  dynlink.cma $(CMA_SO) $^ \
# 	  -cclib '$(APACHE_CFLAGS) $(APACHE_LDFLAGS_SHLIB) $(APACHE_OCAMLLIBS)'

# %.o: %.c
# 	$(APACHE_CC) $(APACHE_CFLAGS) -I $(APACHE_OCAMLLIBDIR) -c $<

# netcgi_apache.so: apache.o handler.o wrappers.o netcgi_apache.cmo
# 	$(OCAMLC) -o $@ -linkall -custom \
# 		-cc '$(APXS) -c' \
# 		dynlink.cma $(CMA_SO) $^

include $(TOP_DIR)/Makefile.rules

# must be after the `include'
ifeq ($(APACHE_MAJOR),2)
CAML_CODE=caml_netcgi_apache.lo
caml_netcgi_apache.lo: caml_netcgi_apache.o
else
CAML_CODE=caml_netcgi_apache.o
endif

netcgi_apache.so: apache.c handler.c wrappers.c $(CAML_CODE)
	$(APXS) -c -o $@ $^ -L$(APACHE_OCAMLLIBDIR) -lunix -lcamlrun
	if [ -f .libs/$@ ]; then cp .libs/$@ . ; fi

caml_netcgi_apache.o: netcgi_apache.ml
	$(OCAMLC) -cc '$(APXS) -c' -output-obj -o $@ dynlink.cma $(CMA_SO)

%.o: %.c
	$(APXS) -c -I$(APACHE_OCAMLLIBDIR) $<

# FIXME: does not work:
CLEAN_LIST += netcgi_apache.so

clean::
	rm -f *.lo *.slo *.la
	if [ -d .libs ]; then rm -rf .libs; fi