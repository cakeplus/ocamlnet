#! /bin/sh

netsys_link_options=""
have_posix_shm=0
have_posix_fadvise=0
have_posix_fallocate=0

######################################################################

printf "Checking for POSIX shared memory... "

posix_shm_compile=0
posix_shm_link_options=""
rm -f configtests/posix_shm.err
if (cd configtests; ocamlc -o posix_shm posix_shm.c main.ml -custom ) \
      >>configtests/posix_shm.err 2>&1
then
    posix_shm_compile=1
else
    if (cd configtests; ocamlc -o posix_shm posix_shm.c main.ml -cclib -lrt -custom ) \
	>>configtests/posix_shm.err 2>&1
    then
	posix_shm_compile=1
	posix_shm_link_options="-lrt"
    fi
fi

if [ $posix_shm_compile -gt 0 ]; then
    if configtests/posix_shm >>configtests/posix_shm.err 2>&1; then
	have_posix_shm=1
	netsys_link_options="$netsys_link_options $posix_shm_link_options"
    fi
fi

if [ $have_posix_shm -gt 0 ]; then
    echo "found"
    def_have_posix_shm="#define HAVE_POSIX_SHM"
else
    echo "not found"
    def_have_posix_shm="#undef HAVE_POSIX_SHM"
fi

######################################################################

printf "Checking for POSIX fadvise... "

posix_fadv_compile=0
posix_fadv_link_options=""
rm -f configtests/posix_fadvise.err
if (cd configtests; ocamlc -o posix_fadvise posix_fadvise.c main.ml -custom ) \
      >>configtests/posix_fadvise.err 2>&1
then
    posix_fadv_compile=1
fi

if [ $posix_fadv_compile -gt 0 ]; then
    if configtests/posix_fadvise >>configtests/posix_fadvise.err 2>&1; then
	have_posix_fadvise=1
	netsys_link_options="$netsys_link_options $posix_fadv_link_options"
    fi
fi

if [ $have_posix_fadvise -gt 0 ]; then
    echo "found"
    def_have_posix_fadvise="#define HAVE_POSIX_FADVISE"
else
    echo "not found"
    def_have_posix_fadvise="#undef HAVE_POSIX_FADVISE"
fi

######################################################################

printf "Checking for POSIX fallocate... "

posix_fallo_compile=0
posix_fallo_link_options=""
rm -f configtests/posix_fallocate.err
if (cd configtests; ocamlc -o posix_fallocate posix_fallocate.c main.ml -custom ) \
      >>configtests/posix_fallocate.err 2>&1
then
    posix_fallo_compile=1
fi

if [ $posix_fallo_compile -gt 0 ]; then
    if configtests/posix_fallocate >>configtests/posix_fallocate.err 2>&1; then
	have_posix_fallocate=1
	netsys_link_options="$netsys_link_options $posix_fallo_link_options"
    fi
fi

if [ $have_posix_fallocate -gt 0 ]; then
    echo "found"
    def_have_posix_fallocate="#define HAVE_POSIX_FALLOCATE"
else
    echo "not found"
    def_have_posix_fallocate="#undef HAVE_POSIX_FALLOCATE"
fi

######################################################################

printf "Checking for win32... "
system=`ocamlc -config | grep system | sed -e 's/system: //'`
case "$system" in
    mingw|msvc)
	  echo "yes"
          netsys_link_options="$netsys_link_options -lws2_32" ;;
	*)
	  echo "no"  ;;
esac


######################################################################


cat <<EOF >Makefile.conf
NETSYS_LINK_OPTIONS = $netsys_link_options
EOF

cat <<EOF >config.h
$def_have_posix_shm
$def_have_posix_fadvise
$def_have_posix_fallocate
EOF

exit 0
