#! /bin/sh

netsys_link_options=""
have_posix_shm=0
have_posix_fadvise=0
have_posix_fallocate=0
have_posix_memalign=0
have_posix_pthread=0
have_printexc_register_printer=0
have_printexc_register_printer_bool=false
code_printexc_register_printer='()'

######################################################################

printf "Checking whether Ocaml has Printexc.register_printer... "
if ( cd configtests; ocamlc -c printexc_register_printer.ml ) \
     >>configtests/printexc_register_printer.err 2>&1
then
    have_printexc_register_printer=1
    have_printexc_register_printer_bool=true
    code_printexc_register_printer = 'Printexc.register_printer f'
fi

if [ $have_printexc_register_printer -gt 0 ]; then
    echo "found"
else
    echo "not found"
fi


######################################################################

printf "Checking for POSIX shared memory... "

posix_shm_compile=0
posix_shm_link_options=""
rm -f configtests/posix_shm.err
if (cd configtests; ocamlc -o posix_shm posix_shm.c main.ml -custom ) \
      >>configtests/posix_shm.err 2>&1
then
    posix_shm_compile=1
else
    if (cd configtests; ocamlc -o posix_shm posix_shm.c main.ml -cclib -lrt -custom ) \
	>>configtests/posix_shm.err 2>&1
    then
	posix_shm_compile=1
	posix_shm_link_options="-lrt"
    fi
fi

if [ $posix_shm_compile -gt 0 ]; then
    if configtests/posix_shm >>configtests/posix_shm.err 2>&1; then
	have_posix_shm=1
	netsys_link_options="$netsys_link_options $posix_shm_link_options"
    fi
fi

if [ $have_posix_shm -gt 0 ]; then
    echo "found"
    def_have_posix_shm="#define HAVE_POSIX_SHM"
else
    echo "not found"
    def_have_posix_shm="#undef HAVE_POSIX_SHM"
fi

######################################################################

printf "Checking for POSIX fadvise... "

posix_fadv_compile=0
posix_fadv_link_options=""
rm -f configtests/posix_fadvise.err
if (cd configtests; ocamlc -o posix_fadvise posix_fadvise.c main.ml -custom ) \
      >>configtests/posix_fadvise.err 2>&1
then
    posix_fadv_compile=1
fi

if [ $posix_fadv_compile -gt 0 ]; then
    if ( cd configtests; ./posix_fadvise >>posix_fadvise.err 2>&1 ); then
	have_posix_fadvise=1
	netsys_link_options="$netsys_link_options $posix_fadv_link_options"
    fi
fi

if [ $have_posix_fadvise -gt 0 ]; then
    echo "found"
    def_have_posix_fadvise="#define HAVE_POSIX_FADVISE"
else
    echo "not found"
    def_have_posix_fadvise="#undef HAVE_POSIX_FADVISE"
fi

######################################################################

printf "Checking for POSIX fallocate... "

posix_fallo_compile=0
posix_fallo_link_options=""
rm -f configtests/posix_fallocate.err
if (cd configtests; ocamlc -o posix_fallocate posix_fallocate.c main.ml -custom ) \
      >>configtests/posix_fallocate.err 2>&1
then
    posix_fallo_compile=1
fi

if [ $posix_fallo_compile -gt 0 ]; then
    if ( cd configtests && ./posix_fallocate >>posix_fallocate.err 2>&1) ; then
	have_posix_fallocate=1
	netsys_link_options="$netsys_link_options $posix_fallo_link_options"
    fi
fi

if [ $have_posix_fallocate -gt 0 ]; then
    echo "found"
    def_have_posix_fallocate="#define HAVE_POSIX_FALLOCATE"
else
    echo "not found"
    def_have_posix_fallocate="#undef HAVE_POSIX_FALLOCATE"
fi
######################################################################

printf "Checking for POSIX memalign... "

posix_malign_compile=0
posix_malign_link_options=""
rm -f configtests/posix_memalign.err
if (cd configtests; ocamlc -o posix_memalign posix_memalign.c main.ml -custom ) \
      >>configtests/posix_memalign.err 2>&1
then
    posix_malign_compile=1
fi

if [ $posix_malign_compile -gt 0 ]; then
    if ( cd configtests && ./posix_memalign >>posix_memalign.err 2>&1) ; then
	have_posix_memalign=1
	netsys_link_options="$netsys_link_options $posix_malign_link_options"
    fi
fi

if [ $have_posix_memalign -gt 0 ]; then
    echo "found"
    def_have_posix_memalign="#define HAVE_POSIX_MEMALIGN"
else
    echo "not found"
    def_have_posix_memalign="#undef HAVE_POSIX_MEMALIGN"
fi

######################################################################

printf "Checking for POSIX pthread... "
posix_pthr_compile=0
posix_pthr_link_options=""
rm -f configtests/posix_pthread.err
if (cd configtests; ocamlc -o posix_pthread posix_pthread.c main.ml -custom ) \
      >>configtests/posix_pthread.err 2>&1
then
    posix_pthr_compile=1
fi

if [ $posix_pthr_compile -gt 0 ]; then
    if configtests/posix_pthread >>configtests/posix_pthread.err 2>&1; then
	have_posix_pthread=1
	netsys_link_options="$netsys_link_options $posix_pthr_link_options"
    fi
fi

if [ $have_posix_pthread -gt 0 ]; then
    echo "found"
    def_have_posix_pthread="#define HAVE_PTHREAD"
else
    echo "not found"
    def_have_posix_pthread="#undef HAVE_PTHREAD"
fi


######################################################################

printf "Checking for win32... "
system=`ocamlc -config | grep system | sed -e 's/system: //'`
case "$system" in
    mingw|msvc)
	  echo "yes"
          netsys_link_options="$netsys_link_options -lws2_32" ;;
	*)
	  echo "no"  ;;
esac


######################################################################


cat <<EOF >Makefile.conf
NETSYS_LINK_OPTIONS = $netsys_link_options
EOF

cat <<EOF >config.h
$def_have_posix_shm
$def_have_posix_fadvise
$def_have_posix_fallocate
$def_have_posix_memalign
$def_have_posix_pthread
EOF

cat <<EOF >netsys_conf.ml
(* This file is written by netsys/configure *)

let have_printexc_register_printer = $have_printexc_register_printer_bool

let printexc_register_printer f =
  $code_printexc_register_printer

EOF

exit 0
